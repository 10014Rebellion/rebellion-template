#!/bin/sh

if [ ! -f ./gradlew ]; then
  echo "Error: Gradle wrapper not found. Please run this script from the root of the project."
  exit 1
fi

echo ""
echo "Checking if spotless needs to be run..."
./gradlew spotlessCheck
if [ $? -ne 0 ]; then
  echo "Spotless check failed. Running spotlessApply to fix formatting issues..."
  ./gradlew spotlessApply
  echo "Error: Spotless has fixed the formatting issues. Please review the changes before committing."
  exit 1
fi

echo ""
echo "Building..."
# skip the createVersionFile task to avoid version file conflicts
./gradlew assemble
if [ $? -ne 0 ]; then
  echo "Error: Build failed. Please fix the errors before committing."
  exit 1
fi

echo ""
echo "Running tests..."
./gradlew test -x eventDeploy
if [ $? -ne 0 ]; then
  echo "Error: Tests failed. Please fix the errors before committing."
  exit 1
fi

exit 0
